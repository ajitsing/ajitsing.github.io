name: IndexNow - Notify Search Engines

on:
  # Trigger after GitHub Pages deployment
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed
  
  # Allow manual trigger with custom URLs
  workflow_dispatch:
    inputs:
      urls:
        description: 'URLs to submit (comma-separated, leave empty for recent posts)'
        required: false
        default: ''

jobs:
  notify-indexnow:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history to compare all commits in push

      - name: Restore last indexed commit
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .last-indexed-commit
          key: last-indexed-commit-${{ github.run_id }}
          restore-keys: |
            last-indexed-commit-

      - name: Get recently changed posts
        id: get-urls
        run: |
          if [ -n "${{ github.event.inputs.urls }}" ]; then
            # Use manually provided URLs
            URLS="${{ github.event.inputs.urls }}"
          else
            # Get the last indexed commit (from cache) or fall back to HEAD~1
            if [ -f .last-indexed-commit ]; then
              LAST_COMMIT=$(cat .last-indexed-commit)
              echo "Last indexed commit: $LAST_COMMIT"
              # Verify commit exists in history
              if git rev-parse --verify "$LAST_COMMIT^{commit}" >/dev/null 2>&1; then
                CHANGED_FILES=$(git diff --name-only "$LAST_COMMIT" HEAD -- '_posts/*.md' '_explainers/*.md' 2>/dev/null || echo "")
              else
                echo "Cached commit not in history, falling back to HEAD~1"
                CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- '_posts/*.md' '_explainers/*.md' 2>/dev/null || echo "")
              fi
            else
              echo "No cached commit found, using HEAD~1"
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- '_posts/*.md' '_explainers/*.md' 2>/dev/null || echo "")
            fi
            
            if [ -z "$CHANGED_FILES" ]; then
              echo "No new posts found"
              echo "has_urls=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Convert file paths to URLs by reading permalink from frontmatter
            URLS=""
            for file in $CHANGED_FILES; do
              # Extract permalink from frontmatter (between --- markers)
              permalink=$(sed -n '/^---$/,/^---$/p' "$file" | grep -E '^permalink:' | sed 's/^permalink:[[:space:]]*//' | tr -d '"' | tr -d "'")
              
              if [ -n "$permalink" ]; then
                # Use permalink from frontmatter
                url="https://singhajit.com${permalink}"
              elif [[ $file == _posts/* ]]; then
                # Fallback: Extract date and slug from post filename
                filename=$(basename "$file" .md)
                url="https://singhajit.com/${filename}/"
              elif [[ $file == _explainers/* ]]; then
                # Fallback for explainers
                slug=$(basename "$file" .md)
                url="https://singhajit.com/explainer/${slug}/"
              fi
              
              if [ -n "$URLS" ]; then
                URLS="${URLS},${url}"
              else
                URLS="${url}"
              fi
            done
          fi
          
          if [ -n "$URLS" ]; then
            echo "urls=$URLS" >> $GITHUB_OUTPUT
            echo "has_urls=true" >> $GITHUB_OUTPUT
            echo "URLs to notify: $URLS"
          else
            echo "has_urls=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Bing IndexNow
        if: steps.get-urls.outputs.has_urls == 'true'
        run: |
          IFS=',' read -ra URL_ARRAY <<< "${{ steps.get-urls.outputs.urls }}"
          
          # Build URL list JSON
          URL_LIST=""
          for url in "${URL_ARRAY[@]}"; do
            if [ -n "$URL_LIST" ]; then
              URL_LIST="${URL_LIST},"
            fi
            URL_LIST="${URL_LIST}\"${url}\""
          done
          
          # Send to Bing
          echo "Notifying Bing IndexNow..."
          curl -s -X POST "https://www.bing.com/indexnow" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"host\": \"singhajit.com\",
              \"key\": \"c7cba40954d441c6866b7aa29ed5c8d6\",
              \"keyLocation\": \"https://singhajit.com/c7cba40954d441c6866b7aa29ed5c8d6.txt\",
              \"urlList\": [${URL_LIST}]
            }"
          
          echo ""
          echo "Notifying Yandex IndexNow..."
          curl -s -X POST "https://yandex.com/indexnow" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"host\": \"singhajit.com\",
              \"key\": \"c7cba40954d441c6866b7aa29ed5c8d6\",
              \"keyLocation\": \"https://singhajit.com/c7cba40954d441c6866b7aa29ed5c8d6.txt\",
              \"urlList\": [${URL_LIST}]
            }"
          
          echo ""
          echo "IndexNow notifications sent!"

      - name: Notify Google PubSubHubbub
        if: steps.get-urls.outputs.has_urls == 'true'
        run: |
          echo "Notifying Google PubSubHubbub hub..."
          curl -s -X POST "https://pubsubhubbub.appspot.com/" \
            -d "hub.mode=publish" \
            -d "hub.url=https://singhajit.com/feed.xml"
          echo ""
          echo "Google PubSubHubbub notification sent!"

      - name: Summary
        if: steps.get-urls.outputs.has_urls == 'true'
        run: |
          echo "### Search Engine Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following URLs were submitted to Bing, Yandex, and Google:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          IFS=',' read -ra URL_ARRAY <<< "${{ steps.get-urls.outputs.urls }}"
          for url in "${URL_ARRAY[@]}"; do
            echo "- $url" >> $GITHUB_STEP_SUMMARY
          done

      - name: Save current commit for next run
        if: always()
        run: |
          git rev-parse HEAD > .last-indexed-commit
          echo "Saved commit $(cat .last-indexed-commit) for next run"

      - name: Cache current commit
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .last-indexed-commit
          key: last-indexed-commit-${{ github.run_id }}

